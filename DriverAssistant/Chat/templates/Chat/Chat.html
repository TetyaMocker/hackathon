{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">

    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/style.css'%}" type="text/css">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

    <link rel="shortcut icon" type="image/png" href="{% static 'img/logo.ico' %}"/>

    <title>Чат c Зиной</title>

    <style>

        @font-face {
            font-family: 'RussianRail G Pro Extended Bold';
            src: url('{% static 'fonts/RussianRailGProExtendedBold.otf' %}') format("truetype");
        }

        body {
            font-family: 'RussianRail G Pro Extended Bold';
        }

        .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
            margin-top: 0;
            margin-bottom: .5rem;
            font-weight: 500;
            line-height: 1.5;
        }

        .card-logo img {
            position: absolute;
            left: 50%;
            top: 50%;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            opacity:0.2
        }

        .card-logo{
            position: relative;
        }

    </style>

</head>

<body class="background-image" style="background-image: url('{% static 'img/background.png'%}');">

<section>

    <div class="container py-5 mt-5">

        <div class="row d-flex justify-content-center">
            <div class="col-md-10 col-lg-10 col-xl-9">

                <div class="card border-0 rounded-0 card-logo" id="chat2">

                    <div class="card-header rounded-0 d-flex justify-content-between align-items-center p-3"
                         style="background-color:#e31b1a">
                        <h5 class="mb-0 text-white">Чат с ассистентом: Зина</h5>

                        <button type="button" class="btn dropdown-toggle rounded-0 text-black"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false" style="background-color: white">
                                Тепловоз
                            </button>
                            <ul class="dropdown-menu rounded-0">
                                <li><a class="dropdown-item" href="#">Тепловоз №1</a></li>
                                <li><a class="dropdown-item" href="#">Тепловоз №2</a></li>
                                <li><a class="dropdown-item" href="#">Тепловоз №3</a></li>
                            </ul>
                    </div>

                    <img src="{% static 'img/logo_chat.png' %}" class="" alt="...">

                    <div class="card-body overflow-auto" id="content" data-mdb-perfect-scrollbar="true"
                         style="position: relative; height: 550px">
                        <div class="d-flex flex-row justify-content-start" id="content-assistant" >
                            <div id="message_user">
                                <p class="small p-2 ms-3 mb-1 rounded-0" style="background-color: #f5f6f7;">Приветствую,
                                    Я Ассистент машиниста Зина! Задайте ваш вопрос?</p>
                            </div>
                        </div>
                    </div>

                    {% csrf_token %}

                    <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
                        <input type="text" class="form-control form-control-lg form-control-sm" id="message"
                               placeholder="Введите сообщение">

                        <a class="ms-1 text-muted" id="enter_message" style="cursor: pointer;">
                            <i class="fas fa-paperclip">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#767d89"
                                     class="bi bi-send" viewBox="0 0 16 16">
                                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                                </svg>
                            </i>
                        </a>

                        <a class="ms-1" id="micro" style="cursor: pointer;г">
                            <i class="fas fa-paperclip" id="microphone_logo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#e31b1a"
                                     class="bi bi-mic" viewBox="0 0 16 16">
                                    <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
                                </svg>
                            </i>
                        </a>

                    </div>

                </div>

            </div>

        </div>

    </div>
</section>


<script>

    var i = 0;
    var answer = 'True'

    //Событие при нажатии на кнопку

    $('#micro').click(function(e){

        // В случае обработки ответа, блокируем микрофон

        if (answer == 'False') {
            e.preventDefault(); // Отменить действие по умолчанию при клике на ссылку
            $(this).prop('disabled', true); // Отключить ссылку
        }
        else{

            // При активации микрофона, выполняем ajax запрос к views для записи голоса и формировании ответа от Зины

            if (i == 0){

                var svg_line = "<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='gray' class='bi bi-mic-mute' viewBox='0 0 16 16'>"
                                  + "<path d='M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879l-1-1V3a2 2 0 0 0-3.997-.118l-.845-.845A3.001 3.001 0 0 1 11 3z'/>"
                                  + "<path d='m9.486 10.607-.748-.748A2 2 0 0 1 6 8v-.878l-1-1V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z'/>"
                             + "</svg>";

                $('#microphone_logo').html(svg_line);

                i = 1

                order_data = {
                    "flag": 'True'
                }

                csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;


                $.ajax({
                    method: "POST",
                    url: "{% url 'record' %}",
                    headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/json; charset=utf-8"},
                    dataType: 'json',
                    data: JSON.stringify(order_data),

                    success: function(result){

                        $('#content').append("<div class='d-flex flex-row justify-content-end mb-3 mt-3 pt-1' id='content-user'>"
                                           + "<div id='message_user' style = 'width: auto; max-width:75%; min-width:1%;'>"
                                              + "<p class='small p-2 me-3 mb-1 text-white' style='background-color:#767d89; width:100%'>" + result.speech2text + "</p>"
                                           + "</div>"
                                          + "</div>"
                                          + "<div class='d-flex flex-row justify-content-start' id='content-assistant'>"
                                             + "<div id='message_assistant' style = 'width: auto; max-width:75%; min-width:1%;'>"
                                                 + "<p class='small p-2 ms-3 mb-1 rounded-0' style='background-color: #f5f6f7; width:100%'>" + result.response_answer + "</p>"
                                            + "</div>"
                                          + "</div>")

                        $('#message').val('')
                        $('#content').scrollTop($('#content')[0].scrollHeight);

                        var audio2 = new Audio('{% static 'wav/recorded_answer.wav' %}');

                        audio2.play();

                        answer = 'True'

                    },

                    error: function(result){
                        alert(result)
                    }

            });

        }else{

            // При нажатии повторно, выключаем микрофон и выполняем ajax запрос

            var svg = "<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='#e31b1a' class='bi bi-mic' viewBox='0 0 16 16'>"
                          + "<path d='M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z'/>"
                          + "<path d='M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z'/>"
                    + "</svg>";

            $('#microphone_logo').html(svg);

            csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            $.ajax({
                method: "POST",
                url: "{% url 'update_flag' %}",
                headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/json; charset=utf-8"},
                dataType: 'json',
            });

            answer = 'False'

            i = 0;
        }

        }
    })


    $('#enter_message').click(function(){

        var message = $('#message').val()

        if (message == ''){
            alert("Пожалуйста, введите сообщение")
        }

        else{
            order_data = {
                "message": message
        }

        csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        $.ajax({
            method: "POST",
            url: "{% url 'message' %}",
            headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/json; charset=utf-8"},
            dataType: 'json',
            data: JSON.stringify(order_data),

            success: function(result){

                $('#content').append("<div class='d-flex flex-row justify-content-end mb-3 mt-3 pt-2' id='content-user'>"
                                       + "<div id='message_user' style = 'width: auto; max-width:75%; min-width:1%;'>"
                                          + "<p class='small p-2 me-3 mb-1 text-white' style='background-color:#767d89; width:100%'>" + message + "</p>"
                                       + "</div>"
                                      + "</div>"
                                      + "<div class='d-flex flex-row justify-content-start' id='content-assistant'>"
                                         + "<div id='message_assistant' style = 'width: auto; max-width:75%; min-width:1%;'>"
                                             + "<p class='small p-2 ms-3 mb-1 rounded-0' style='background-color: #f5f6f7; width:100%;'>" + result + "</p>"
                                        + "</div>"
                                      + "</div>")

                $('#message').val('')
                $('#content').scrollTop($('#content')[0].scrollHeight);

                var audio2 = new Audio('{% static 'wav/recorded_answer.wav' %}');

                audio2.play();

            },

            error: function(result){
                alert(result)
            }
        });

        }
    })
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>

</body>
</html>